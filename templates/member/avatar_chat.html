{% extends 'base.html' %}

{% block page_title %}{{ avatar.name }} ile Sohbet{% endblock %}
{% block page_description %}AI avatarınızla interaktif sohbet deneyimi yaşayın{% endblock %}

{% block content %}
<div class="flex h-full">
    <!-- Avatar Info Sidebar -->
    <div class="w-80 glass-effect border-r border-white/20 dark:border-gray-700/30 flex flex-col relative overflow-hidden">
        <!-- Background Pattern -->
        <div class="absolute inset-0 opacity-5">
            <div class="absolute top-10 left-10 w-20 h-20 bg-pink-500 rounded-full animate-pulse"></div>
            <div class="absolute bottom-20 right-10 w-16 h-16 bg-rose-500 rounded-full animate-pulse" style="animation-delay: 1s"></div>
            <div class="absolute top-1/2 left-1/2 w-12 h-12 bg-purple-500 rounded-full animate-pulse" style="animation-delay: 2s"></div>
        </div>
        
        <!-- Avatar Profile -->
        <div class="relative z-10 p-6 border-b border-white/20 dark:border-gray-700/30">
            <div class="text-center">
                <!-- Avatar Image Container -->
                <div class="relative inline-block mb-6">
                    <div class="w-28 h-28 mx-auto bg-gradient-to-br from-pink-200 via-rose-200 to-purple-200 rounded-full flex items-center justify-center shadow-2xl relative overflow-hidden border-4 border-white/50 dark:border-gray-800/50">
                        {% if avatar.avatar_image %}
                            <img src="{{ avatar.avatar_image.url }}" alt="{{ avatar.name }}" class="w-full h-full object-cover rounded-full">
                        {% else %}
                            <svg class="w-16 h-16 text-pink-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                            </svg>
                        {% endif %}
                    </div>
                    
                    <!-- Status Indicators -->
                    <div class="absolute bottom-0 right-0 w-6 h-6 bg-green-500 rounded-full border-3 border-white dark:border-gray-800 flex items-center justify-center">
                        <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
                    </div>
                    
                    <!-- Mood Indicator -->
                    <div class="absolute -top-2 -right-2 w-8 h-8 bg-yellow-400 rounded-full flex items-center justify-center animate-bounce">
                        <span class="text-sm">😊</span>
                    </div>
                </div>
                
                <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">{{ avatar.name }}</h3>
                <div class="flex items-center justify-center space-x-2 mb-4">
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                    <p class="text-sm text-green-600 dark:text-green-400 font-medium">Aktif ve hazır</p>
                </div>
                
                <!-- Avatar Stats Grid -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="glass-effect rounded-xl p-3 border border-white/20">
                        <div class="text-2xl mb-1">😊</div>
                        <p class="text-xs text-gray-600 dark:text-gray-400">Ruh Hali</p>
                        <p class="text-xs font-semibold text-gray-800 dark:text-white">Mutlu</p>
                    </div>
                    <div class="glass-effect rounded-xl p-3 border border-white/20">
                        <div class="text-2xl mb-1">⚡</div>
                        <p class="text-xs text-gray-600 dark:text-gray-400">Enerji</p>
                        <p class="text-xs font-semibold text-gray-800 dark:text-white">Yüksek</p>
                    </div>
                    <div class="glass-effect rounded-xl p-3 border border-white/20">
                        <div class="text-2xl mb-1">🧠</div>
                        <p class="text-xs text-gray-600 dark:text-gray-400">Zeka</p>
                        <p class="text-xs font-semibold text-gray-800 dark:text-white">AI</p>
                    </div>
                    <div class="glass-effect rounded-xl p-3 border border-white/20">
                        <div class="text-2xl mb-1">💬</div>
                        <p class="text-xs text-gray-600 dark:text-gray-400">Mesajlar</p>
                        <p class="text-xs font-semibold text-gray-800 dark:text-white">{{ messages.count|default:0 }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Avatar Details -->
        <div class="relative z-10 p-6 flex-1 overflow-y-auto custom-scrollbar">
            <h4 class="font-semibold text-gray-800 dark:text-white mb-4 flex items-center space-x-2">
                <span>🎭</span>
                <span>Avatar Özellikleri</span>
            </h4>
            <div class="space-y-4">
                <div class="glass-effect rounded-xl p-4 border border-white/20">
                    <div class="flex items-center space-x-3 mb-2">
                        <span class="text-lg">🎨</span>
                        <p class="text-xs text-gray-600 dark:text-gray-400">Stil</p>
                    </div>
                    <p class="font-medium text-gray-800 dark:text-white">{{ avatar.get_style_display }}</p>
                </div>
                <div class="glass-effect rounded-xl p-4 border border-white/20">
                    <div class="flex items-center space-x-3 mb-2">
                        <span class="text-lg">💇‍♀️</span>
                        <p class="text-xs text-gray-600 dark:text-gray-400">Saç Rengi</p>
                    </div>
                    <p class="font-medium text-gray-800 dark:text-white">{{ avatar.get_hair_color_display }}</p>
                </div>
                <div class="glass-effect rounded-xl p-4 border border-white/20">
                    <div class="flex items-center space-x-3 mb-2">
                        <span class="text-lg">👁️</span>
                        <p class="text-xs text-gray-600 dark:text-gray-400">Göz Rengi</p>
                    </div>
                    <p class="font-medium text-gray-800 dark:text-white">{{ avatar.get_eye_color_display }}</p>
                </div>
                {% if avatar.personality %}
                <div class="glass-effect rounded-xl p-4 border border-white/20">
                    <div class="flex items-center space-x-3 mb-2">
                        <span class="text-lg">🧠</span>
                        <p class="text-xs text-gray-600 dark:text-gray-400">Kişilik</p>
                    </div>
                    <p class="text-sm text-gray-800 dark:text-white leading-relaxed">{{ avatar.personality|truncatewords:25 }}</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Quick Actions */
            <div class="mt-8">
                <h4 class="font-semibold text-gray-800 dark:text-white mb-4 flex items-center space-x-2">
                    <span>⚡</span>
                    <span>Hızlı Eylemler</span>
                </h4>
                <div class="space-y-3">
                    <button onclick="sendQuickMessage('Merhaba {{ avatar.name }}! Nasılsın?')" class="w-full text-left p-3 glass-effect rounded-xl hover:bg-pink-50 dark:hover:bg-pink-900/20 transition-all duration-200 border border-white/20 group">
                        <div class="flex items-center space-x-3">
                            <div class="p-2 gradient-bg rounded-lg group-hover:scale-110 transition-transform">
                                <span class="text-white">👋</span>
                            </div>
                            <span class="text-sm font-medium text-gray-800 dark:text-white">Selamla</span>
                        </div>
                    </button>
                    <button onclick="sendQuickMessage('Bugün ne yapmak istiyorsun?')" class="w-full text-left p-3 glass-effect rounded-xl hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all duration-200 border border-white/20 group">
                        <div class="flex items-center space-x-3">
                            <div class="p-2 bg-blue-500 rounded-lg group-hover:scale-110 transition-transform">
                                <span class="text-white">💭</span>
                            </div>
                            <span class="text-sm font-medium text-gray-800 dark:text-white">Plan Yap</span>
                        </div>
                    </button>
                    <button onclick="sendQuickMessage('Bana bir şaka anlat')" class="w-full text-left p-3 glass-effect rounded-xl hover:bg-yellow-50 dark:hover:bg-yellow-900/20 transition-all duration-200 border border-white/20 group">
                        <div class="flex items-center space-x-3">
                            <div class="p-2 bg-yellow-500 rounded-lg group-hover:scale-110 transition-transform">
                                <span class="text-white">😄</span>
                            </div>
                            <span class="text-sm font-medium text-gray-800 dark:text-white">Şaka Anlat</span>
                        </div>
                    </button>
                    <button onclick="sendQuickMessage('Benimle bir oyun oynamak ister misin?')" class="w-full text-left p-3 glass-effect rounded-xl hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-all duration-200 border border-white/20 group">
                        <div class="flex items-center space-x-3">
                            <div class="p-2 bg-purple-500 rounded-lg group-hover:scale-110 transition-transform">
                                <span class="text-white">🎮</span>
                            </div>
                            <span class="text-sm font-medium text-gray-800 dark:text-white">Oyun Oyna</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Avatar Button -->
        <div class="relative z-10 p-4 border-t border-white/20 dark:border-gray-700/30">
            <a href="{% url 'member:avatar_create' %}" class="block w-full text-center px-4 py-3 glass-effect rounded-xl hover:bg-white/30 dark:hover:bg-gray-700/30 transition-all duration-200 text-gray-700 dark:text-gray-300 border border-white/20 group">
                <div class="flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5 group-hover:rotate-12 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                    </svg>
                    <span class="font-medium">Avatar Düzenle</span>
                </div>
            </a>
        </div>
    </div>

    <!-- Chat Area -->
    <div class="flex-1 flex flex-col min-w-0">
        <!-- Chat Header -->
        <div class="p-6 border-b border-white/20 dark:border-gray-700/30 glass-effect">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <div class="w-12 h-12 bg-gradient-to-br from-pink-200 via-rose-200 to-purple-200 rounded-full flex items-center justify-center shadow-lg">
                            {% if avatar.avatar_image %}
                                <img src="{{ avatar.avatar_image.url }}" alt="{{ avatar.name }}" class="w-full h-full object-cover rounded-full">
                            {% else %}
                                <svg class="w-6 h-6 text-pink-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                                </svg>
                            {% endif %}
                        </div>
                        <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-400 rounded-full border-2 border-white dark:border-gray-800 animate-pulse"></div>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 dark:text-white text-lg">{{ avatar.name }} ile Sohbet</h3>
                        <div class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
                            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                            <span>Şimdi aktif</span>
                            <span>•</span>
                            <span>Yanıt süresi: ~1-2 saniye</span>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Actions -->
                <div class="flex items-center space-x-3">
                    <button class="p-2 glass-effect rounded-lg hover:bg-white/30 dark:hover:bg-gray-700/30 transition-colors">
                        <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"/>
                        </svg>
                    </button>
                    <button class="p-2 glass-effect rounded-lg hover:bg-white/30 dark:hover:bg-gray-700/30 transition-colors">
                        <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages Area -->
        <div class="flex-1 overflow-y-auto p-6 custom-scrollbar" id="chatArea" style="background: linear-gradient(135deg, rgba(249, 250, 251, 0.5) 0%, rgba(243, 244, 246, 0.5) 100%);">
            <div class="max-w-4xl mx-auto space-y-6" id="messagesContainer">
                {% if not messages %}
                <!-- Welcome Message from Avatar -->
                <div class="flex justify-start animate-fadeIn">
                    <div class="max-w-md group">
                        <div class="glass-effect rounded-2xl p-6 border border-white/20 shadow-lg">
                            <!-- Avatar Info Header -->
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-10 h-10 gradient-bg rounded-full flex items-center justify-center">
                                    <span class="text-white font-bold text-sm">{{ avatar.name.0 }}</span>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-gray-800 dark:text-white">{{ avatar.name }}</p>
                                    <div class="flex items-center space-x-1">
                                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                        <span class="text-xs text-green-600 dark:text-green-400">Aktif</span>
                                    </div>
                                </div>
                            </div>
                            <p class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed mb-3">
                                Merhaba! Ben {{ avatar.name }}, senin kişisel AI avatarın. Bugün nasılsın? Seninle sohbet etmeyi çok seviyorum! 🌟
                            </p>
                            <div class="flex items-center justify-between">
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{ "now"|date:"H:i" }}</p>
                                <div class="flex space-x-1">
                                    <div class="w-1 h-1 bg-pink-400 rounded-full animate-pulse"></div>
                                    <div class="w-1 h-1 bg-pink-400 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                                    <div class="w-1 h-1 bg-pink-400 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Introduction Cards -->
                <div class="grid md:grid-cols-2 gap-4 max-w-2xl mx-auto">
                    <div class="glass-effect rounded-xl p-4 border border-white/20 text-center">
                        <div class="text-3xl mb-2">🎯</div>
                        <h4 class="font-semibold text-gray-800 dark:text-white mb-1">Kişiselleştirilmiş</h4>
                        <p class="text-xs text-gray-600 dark:text-gray-400">Size özel yanıtlar</p>
                    </div>
                    <div class="glass-effect rounded-xl p-4 border border-white/20 text-center">
                        <div class="text-3xl mb-2">⚡</div>
                        <h4 class="font-semibold text-gray-800 dark:text-white mb-1">Hızlı Yanıt</h4>
                        <p class="text-xs text-gray-600 dark:text-gray-400">Anında etkileşim</p>
                    </div>
                </div>
                {% else %}
                <!-- Existing Messages -->
                {% for message in messages %}
                <div class="flex {% if message.is_bot_response %}justify-start{% else %}justify-end{% endif %} animate-fadeIn">
                    <div class="max-w-md group">
                        <div class="px-6 py-4 rounded-2xl glass-effect border border-white/20 shadow-lg transition-all duration-200 hover:scale-105
                            {% if message.is_bot_response %}
                                text-gray-800 dark:text-gray-100
                            {% else %}
                                gradient-bg text-white shadow-pink-500/25
                            {% endif %}">
                            
                            {% if message.is_bot_response %}
                            <!-- Bot Avatar Header -->
                            <div class="flex items-center space-x-3 mb-3">
                                <div class="w-8 h-8 gradient-bg rounded-full flex items-center justify-center">
                                    <span class="text-white text-sm font-bold">{{ avatar.name.0 }}</span>
                                </div>
                                <div>
                                    <p class="text-sm font-medium">{{ avatar.name }}</p>
                                    <div class="flex items-center space-x-1">
                                        <div class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></div>
                                        <span class="text-xs text-green-600 dark:text-green-400">Aktif</span>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            <p class="text-sm leading-relaxed">{{ message.message }}</p>
                            
                            <div class="flex items-center justify-between mt-3">
                                <p class="text-xs {% if message.is_bot_response %}text-gray-500 dark:text-gray-400{% else %}text-pink-100{% endif %}">
                                    {{ message.created_at|date:"H:i" }}
                                </p>
                                
                                {% if not message.is_bot_response %}
                                <div class="flex space-x-1">
                                    <svg class="w-4 h-4 text-pink-200" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                    <svg class="w-4 h-4 text-pink-200" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% endif %}
                
                <!-- Enhanced Typing Indicator -->
                <div id="typingIndicator" class="flex justify-start hidden animate-fadeIn">
                    <div class="max-w-md">
                        <div class="px-6 py-4 glass-effect rounded-2xl border border-white/20 shadow-lg">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 gradient-bg rounded-full flex items-center justify-center">
                                    <span class="text-white text-sm font-bold">{{ avatar.name.0 }}</span>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <div class="flex space-x-1">
                                        <div class="w-2 h-2 bg-pink-500 rounded-full animate-bounce"></div>
                                        <div class="w-2 h-2 bg-pink-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                        <div class="w-2 h-2 bg-pink-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                    </div>
                                    <span class="text-sm text-gray-500 dark:text-gray-400 ml-3">{{ avatar.name }} yazıyor...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Message Input -->
        <div class="p-6 border-t border-white/20 dark:border-gray-700/30 glass-effect">
            <form id="messageForm" class="flex space-x-4">
                {% csrf_token %}
                <div class="flex-1 relative">
                    <input
                        type="text"
                        id="messageInput"
                        placeholder="{{ avatar.name }}'a mesaj yaz..."
                        class="w-full pl-6 pr-16 py-4 glass-effect rounded-2xl border border-white/20 dark:border-gray-600/30 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 transition-all duration-200"
                        autocomplete="off"
                    />
                    <!-- Character Counter -->
                    <div class="absolute right-4 top-1/2 transform -translate-y-1/2">
                        <span id="charCounter" class="text-xs text-gray-400">0/300</span>
                    </div>
                </div>
                <button
                    type="submit"
                    id="sendButton"
                    disabled
                    class="px-8 py-4 bg-gray-300 text-gray-500 rounded-2xl cursor-not-allowed transition-all duration-200 flex items-center space-x-2 shadow-lg relative overflow-hidden"
                >
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
                    </svg>
                    <span>Gönder</span>
                    
                    <!-- Sending Animation -->
                    <div id="sendingAnimation" class="absolute inset-0 gradient-bg rounded-2xl flex items-center justify-center opacity-0 transition-opacity duration-200">
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                    </div>
                </button>
            </form>
            
            <!-- Avatar Status -->
            <div class="flex items-center justify-center mt-4">
                <div class="flex items-center space-x-2 text-xs text-gray-500 dark:text-gray-400">
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                    <span>{{ avatar.name }} hazır ve dinliyor</span>
                    <span>•</span>
                    <span>Kişilik: {{ avatar.get_style_display }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const messageForm = document.getElementById('messageForm');
    const messagesContainer = document.getElementById('messagesContainer');
    const chatArea = document.getElementById('chatArea');
    const typingIndicator = document.getElementById('typingIndicator');
    const charCounter = document.getElementById('charCounter');
    const sendingAnimation = document.getElementById('sendingAnimation');

    // Character counter
    messageInput.addEventListener('input', function() {
        const length = this.value.length;
        const maxLength = 300;
        charCounter.textContent = `${length}/${maxLength}`;
        
        if (length > maxLength * 0.8) {
            charCounter.classList.add('text-orange-500');
        } else if (length > maxLength * 0.9) {
            charCounter.classList.add('text-red-500');
        } else {
            charCounter.classList.remove('text-orange-500', 'text-red-500');
        }
        
        updateSendButton();
    });

    function updateSendButton() {
        const hasText = messageInput.value.trim().length > 0;
        sendButton.disabled = !hasText;
        
        if (hasText) {
            sendButton.className = 'px-8 py-4 gradient-bg text-white rounded-2xl hover:shadow-xl transition-all duration-200 transform hover:scale-105 shadow-lg flex items-center space-x-2 relative overflow-hidden';
        } else {
            sendButton.className = 'px-8 py-4 bg-gray-300 text-gray-500 rounded-2xl cursor-not-allowed transition-all duration-200 flex items-center space-x-2 shadow-lg relative overflow-hidden';
        }
    }

    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        sendMessage();
    });

    function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        // Show sending animation
        sendingAnimation.style.opacity = '1';
        sendButton.disabled = true;

        addMessageToChat(message, false);
        messageInput.value = '';
        charCounter.textContent = '0/300';
        updateSendButton();
        
        showTypingIndicator();
        
        fetch('{% url "member:avatar_chat" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                message: message
            })
        })
        .then(response => response.json())
        .then(data => {
            hideTypingIndicator();
            sendingAnimation.style.opacity = '0';
            
            if (data.success && data.bot_response) {
                setTimeout(() => {
                    addMessageToChat(data.bot_response.message, true);
                }, 1000);
            }
        })
        .catch(error => {
            hideTypingIndicator();
            sendingAnimation.style.opacity = '0';
            console.error('Error:', error);
            addMessageToChat('Üzgünüm, bir hata oluştu. Lütfen tekrar deneyin. 😔', true);
        });
    }

    function sendQuickMessage(message) {
        messageInput.value = message;
        messageInput.dispatchEvent(new Event('input'));
        sendMessage();
    }

    function addMessageToChat(message, isBot) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex ${isBot ? 'justify-start' : 'justify-end'} animate-fadeIn`;
        
        const now = new Date();
        const time = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        
        const botHeader = isBot ? `
            <div class="flex items-center space-x-3 mb-3">
                <div class="w-8 h-8 gradient-bg rounded-full flex items-center justify-center">
                    <span class="text-white text-sm font-bold">{{ avatar.name.0 }}</span>
                </div>
                <div>
                    <p class="text-sm font-medium">{{ avatar.name }}</p>
                    <div class="flex items-center space-x-1">
                        <div class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></div>
                        <span class="text-xs text-green-600 dark:text-green-400">Aktif</span>
                    </div>
                </div>
            </div>
        ` : '';
        
        const statusIcons = !isBot ? `
            <div class="flex space-x-1">
                <svg class="w-4 h-4 text-pink-200" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
                <svg class="w-4 h-4 text-pink-200" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
            </div>
        ` : '';
        
        messageDiv.innerHTML = `
            <div class="max-w-md group">
                <div class="px-6 py-4 rounded-2xl glass-effect border border-white/20 shadow-lg transition-all duration-200 hover:scale-105 ${
                    isBot 
                        ? 'text-gray-800 dark:text-gray-100'
                        : 'gradient-bg text-white shadow-pink-500/25'
                }">
                    ${botHeader}
                    <p class="text-sm leading-relaxed">${message}</p>
                    <div class="flex items-center justify-between mt-3">
                        <p class="text-xs ${isBot ? 'text-gray-500 dark:text-gray-400' : 'text-pink-100'}">
                            ${time}
                        </p>
                        ${statusIcons}
                    </div>
                </div>
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        scrollToBottom();
    }

    function showTypingIndicator() {
        typingIndicator.classList.remove('hidden');
        scrollToBottom();
    }

    function hideTypingIndicator() {
        typingIndicator.classList.add('hidden');
    }

    function scrollToBottom() {
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    // Auto-scroll to bottom on page load
    setTimeout(scrollToBottom, 100);
    
    // Focus on input
    setTimeout(() => messageInput.focus(), 500);
</script>

<style>
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.animate-fadeIn {
    animation: fadeIn 0.3s ease-out;
}

/* Enhanced scrollbar */
.custom-scrollbar::-webkit-scrollbar {
    width: 6px;
}

.custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #ec4899, #f43f5e);
    border-radius: 10px;
}

/* Message hover effects */
.group:hover .glass-effect {
    background: rgba(255, 255, 255, 0.9);
    transform: scale(1.02);
}

.dark .group:hover .glass-effect {
    background: rgba(31, 41, 55, 0.9);
}

/* Chat area background */
#chatArea {
    background: linear-gradient(135deg, rgba(249, 250, 251, 0.5) 0%, rgba(243, 244, 246, 0.5) 100%);
}

.dark #chatArea {
    background: linear-gradient(135deg, rgba(17, 24, 39, 0.5) 0%, rgba(31, 41, 55, 0.5) 100%);
}
</style>
{% endblock %}